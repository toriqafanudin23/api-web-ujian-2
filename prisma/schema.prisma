// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum QuestionType {
  MULTIPLE_CHOICE
  SHORT_ANSWER
  ESSAY
  PHOTO_UPLOAD
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum GradingStatus {
  AUTO_GRADED
  PENDING_REVIEW
  GRADED
}

model Exam {
  id          String   @id @default(uuid())
  title       String
  description String   @db.Text
  code        String   @unique
  duration    Int      // in minutes
  startTime   DateTime
  endTime     DateTime
  isActive    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Settings stored as JSON for flexibility
  securitySettings Json? // { requireFullscreen, enableProctoring, ... }
  gradingSettings  Json? // { autoReleaseGrades, requireReview, ... }

  questions   Question[]
  results     ExamResult[]

  @@map("exams")
}

model Question {
  id            String       @id @default(uuid())
  examId        String
  type          QuestionType
  text          String       @db.Text
  points        Int          @default(0)
  imageUrl      String?
  correctAnswer String?      @db.Text // For Short Answer
  sampleAnswer  String?      @db.Text // For Essay reference
  keywords      String[]     // For auto-grading help
  difficulty    Difficulty?
  tags          String[]
  
  // Reference to Question Bank source
  questionBankId String?
  isFromBank     Boolean      @default(false)

  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  sourceBank    QuestionBank? @relation(fields: [questionBankId], references: [id])
  
  options       QuestionOption[]
  rubric        GradingRubric?
  studentAnswers StudentAnswer[]

  @@map("questions")
}

model QuestionOption {
  id             String        @id @default(uuid())
  text           String
  isCorrect      Boolean       @default(false)
  
  // Can belong to an Exam Question or a Bank Question
  questionId     String?
  question       Question?     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  questionBankId String?
  questionBank   QuestionBank? @relation(fields: [questionBankId], references: [id], onDelete: Cascade)

  @@map("question_options")
}

model QuestionBank {
  id            String       @id @default(uuid())
  type          QuestionType
  text          String       @db.Text
  subject       String
  topic         String
  difficulty    Difficulty
  tags          String[]
  points        Int          @default(0)
  imageUrl      String?
  correctAnswer String?      @db.Text
  
  createdBy     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  usageCount    Int          @default(0)
  isPublic      Boolean      @default(true)

  options       QuestionOption[]
  copies        Question[]   // Questions copied from this bank item

  @@map("question_bank")
}

model GradingRubric {
  id         String   @id @default(uuid())
  questionId String   @unique
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  criteria   GradingCriteria[]
  templates  GradeTemplate[]

  @@map("grading_rubrics")
}

model GradingCriteria {
  id          String        @id @default(uuid())
  rubricId    String
  rubric      GradingRubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  name        String
  maxPoints   Int
  description String        @db.Text

  @@map("grading_criteria")
}

model GradeTemplate {
  id          String        @id @default(uuid())
  rubricId    String
  rubric      GradingRubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  label       String
  percentage  Float
  comment     String?

  @@map("grade_templates")
}

model ExamResult {
  id             String        @id @default(uuid())
  examId         String
  studentName    String
  score          Float         @default(0)
  correctCount   Int           @default(0)
  totalQuestions Int
  gradingStatus  GradingStatus @default(AUTO_GRADED)
  submittedAt    DateTime      @default(now())
  
  // JSON fields for complex/nested data
  proctoringData Json?         // { suspiciousActivities: [], webcamPhotos: [] }
  activityLog    Json?         // Audit log of student actions
  feedback       Json?         // General feedback

  exam           Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers        StudentAnswer[]

  @@map("exam_results")
}

model StudentAnswer {
  id            String        @id @default(uuid())
  examResultId  String
  questionId    String
  answer        String        @db.Text // Text answer or photo URL
  
  manualGrade   Float?        // Score given by grader
  feedback      String?       @db.Text
  
  result        ExamResult    @relation(fields: [examResultId], references: [id], onDelete: Cascade)
  question      Question      @relation(fields: [questionId], references: [id])

  @@map("student_answers")
}